---
# Test workflow for PREQ-4210: mise installs JFrog CLI as `jf`, not `jfrog`.
# Fix: use `jf` instead of `jfrog` in commands (e.g. `jf rt bpr`).
name: Test JFrog Path
on:
  push:

jobs:
  discover-mise-install:
    name: "0. Discover mise install path"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI 2.92.0)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.92.0
      - name: Diagnose mise install
        run: |
          echo "=== mise where jfrog ==="
          mise where jfrog || true
          echo "=== mise where jf ==="
          mise where jf || true
          echo "=== mise ls ==="
          mise ls || true
          echo "=== MISE_INSTALLS dir ==="
          ls -la "${HOME}/.local/share/mise/installs/" 2>/dev/null || true
          echo "=== jfrog-cli dir ==="
          ls -la "${HOME}/.local/share/mise/installs/jfrog-cli/" 2>/dev/null || true
          echo "=== PATH ==="
          echo "$PATH"
          echo "=== which jfrog / jf ==="
          which jfrog 2>/dev/null || echo "jfrog not in PATH"
          which jf 2>/dev/null || echo "jf not in PATH"

  test-1-repo-name-unfilled-direct-jf:
    name: "1. REPO_NAME unfilled, direct jf (2.92.0)"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI 2.92.0)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.92.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jf rt ping (REPO_NAME unfilled, direct call)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          jf rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-2-repo-name-filled-direct-jf:
    name: "2. REPO_NAME filled, direct jf (2.92.0)"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI 2.92.0)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.92.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jf rt ping (REPO_NAME filled, direct call)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          jf rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-3-mise-exec-repo-name-unfilled:
    name: "3. REPO_NAME unfilled, mise exec -- jf (2.92.0)"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI 2.92.0)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.92.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jf rt ping (mise exec, REPO_NAME unfilled)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          mise exec -- jf rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-4-jfrog-full-path:
    name: "4. Full path (mise where) to jfrog (2.92.0)"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI 2.92.0)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.92.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jfrog rt ping (full path from mise where)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          JFROG_BIN=$(mise where jfrog 2>/dev/null || mise where jf 2>/dev/null || echo "")
          if [ -z "$JFROG_BIN" ]; then
            echo "mise where failed, trying standard path for 2.92.0"
            JFROG_BIN="${HOME}/.local/share/mise/installs/jfrog-cli/2.92.0/bin/jfrog"
            [ ! -f "$JFROG_BIN" ] && JFROG_BIN="${HOME}/.local/share/mise/installs/jfrog-cli/2.92.0/bin/jf"
          fi
          echo "Using: $JFROG_BIN"
          "$JFROG_BIN" rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-5-setup-jfrog-cli-action:
    name: "5. jfrog/setup-jfrog-cli action v4 (2.92.0)"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Setup JFrog CLI (official action)
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: "2.92.0"
        env:
          JF_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          JF_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
      - name: Test jf rt ping (setup-jfrog-cli)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          jf rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"
