---
# Test workflow to diagnose jfrog PATH issue in Release step
# Trigger: push (for testing on unmerged PR branches)
# Tests 4 ways to invoke jfrog after mise install
name: Test JFrog Path
on:
  push:

jobs:
  test-1-repo-name-unfilled-direct-jfrog:
    name: "1. REPO_NAME unfilled, direct jfrog"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.77.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jfrog rt ping (REPO_NAME unfilled, direct call)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          jfrog rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-2-repo-name-filled-direct-jfrog:
    name: "2. REPO_NAME filled, direct jfrog"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.77.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jfrog rt ping (REPO_NAME filled, direct call)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          jfrog rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-3-mise-exec-repo-name-unfilled:
    name: "3. REPO_NAME unfilled, mise exec -- jfrog"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.77.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jfrog rt ping (mise exec, REPO_NAME unfilled)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          echo "REPO_NAME='${REPO_NAME}'"
          mise exec -- jfrog rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"

  test-4-jfrog-full-path:
    name: "4. Full path to jfrog binary"
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      contents: read
    env:
      REPO_NAME: ${{ github.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Mise (and JFrog CLI)
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # 3.5.1
        with:
          version: 2025.12.10
          tool_versions: |
            jfrog-cli 2.77.0
      - name: Get secrets from Vault
        id: vault-secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
      - name: Test jfrog rt ping (full path)
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.vault-secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          JFROG_BIN="${HOME}/.local/share/mise/installs/jfrog-cli/2.77.0/bin/jfrog"
          echo "Using: $JFROG_BIN"
          "$JFROG_BIN" rt ping --url "${ARTIFACTORY_URL}" --access-token "${ARTIFACTORY_ACCESS_TOKEN}"
